{
  "version": 3,
  "file": "upgrade_retain_kairo_oraclize.js",
  "sourceRoot": "",
  "sources": [
    "upgrade_retain_kairo_oraclize.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "BetokenFund = artifacts.require(\"BetokenFund\")\r\nControlToken = artifacts.require(\"ControlToken\")\r\nOraclizeHandler = artifacts.require(\"OraclizeHandler\")\r\n\r\nconfig = require \"../deployment_configs/testnet.json\"\r\n\r\ndev_fee_address = \"0xDbE011EB3fe8C77C94Cc9d9EC176BDddC937F425\"\r\nold_address = \"0x7c9c1ca8abe245e34bcd56d88ef320560ace7a4e\"\r\nstart_cycle_number = 0\r\n\r\nmodule.exports = (callback) ->\r\n  old_contract = BetokenFund.at(old_address)\r\n  new_contract = null\r\n\r\n  old_contract.pause().then(\r\n    () ->\r\n      #Deploy new BetokenFund\r\n      BetokenFund.new(\r\n        config.etherDeltaAddress, #Ethdelta address\r\n        dev_fee_address, #developerFeeAccount\r\n        config.precision, #precision\r\n        config.timeOfChangeMaking,#2 * 24 * 3600, #timeOfChangeMaking\r\n        config.timeOfProposalMaking,#2 * 24 * 3600, #timeOfProposalMaking\r\n        config.timeOfWaiting, #timeOfWaiting\r\n        config.timeOfSellOrderWaiting, #timeOfSellOrderWaiting\r\n        config.minStakeProportion, #minStakeProportion\r\n        config.maxProposals, #maxProposals\r\n        config.commissionRate, #commissionRate\r\n        config.orderExpirationTimeInBlocks,#3600 / 20, #orderExpirationTimeInBlocks\r\n        config.developerFeeProportion, #developerFeeProportion\r\n        config.maxProposalsPerMember, #maxProposalsPerMember\r\n        start_cycle_number #cycleNumber\r\n      ).then(\r\n        (_instance) ->\r\n          new_contract = _instance\r\n          console.log(\"Created new BetokenFund at \" + _instance.address)\r\n      )\r\n  ).then(\r\n    () ->\r\n      #Transfer participants data\r\n      participants = []\r\n      oraclizeAddr = null\r\n      kairoAddr = null\r\n\r\n      old_contract.participantsCount().then(\r\n        (_count) ->\r\n          count = _count.toNumber()\r\n          if count == 0\r\n            return\r\n          participants = new Array(count)\r\n          getItem = (id) ->\r\n            return old_contract.participants(id).then(\r\n              (_item) ->\r\n                return new Promise((fullfill, reject) ->\r\n                  if typeof _item != null\r\n                    participants[id] = _item\r\n                    fullfill()\r\n                  else\r\n                    reject()\r\n                  return\r\n                )\r\n            )\r\n          getAllItems = (getItem(id) for id in [0..count - 1])\r\n          return Promise.all(getAllItems)\r\n      ).then(\r\n        () ->\r\n          new_contract.initializeParticipants(participants.filter((v, i, a) -> a.indexOf(v) == i))\r\n          console.log \"Initializing participant list...\"\r\n      ).then(\r\n        #Initialize subcontracts for new BetokenFund\r\n        () -> old_contract.controlTokenAddr()\r\n      ).then(\r\n        (_addr) -> kairoAddr = _addr\r\n      ).then(\r\n        () -> old_contract.oraclizeAddr()\r\n      ).then(\r\n        (_addr) -> oraclizeAddr = _addr\r\n      ).then(\r\n        () -> new_contract.initializeSubcontracts(kairoAddr, oraclizeAddr)\r\n      )\r\n\r\n      #Transfer ownership\r\n      old_contract.changeOraclizeOwner(new_contract.address)\r\n      old_contract.changeControlTokenOwner(new_contract.address)\r\n  )\r\n"
  ]
}